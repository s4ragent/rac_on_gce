---
#https://www.server-world.info/query?os=CentOS_8&p=nfs
  - name: "install nfs packages"
    become: yes
    dnf: 
      name: nfs-utils
      state: present
    tags:
      - nfsserver

  - name: "create nfs root directory"
    become: yes
    file: 
      path: "{{ STORAGE_ROOT }}" 
      state: directory
      owner: root 
      group: root
      mode: 0755
    tags:
      - nfsserver

  - name: "create exports"
    become: yes
    template: 
      src: exports.j2
      dest: /etc/exports
      owner: root
      group: root
      mode: 0644
    tags:
      - nfsserver

  - name: "restart nfs"
    become: yes
    systemd:
      name: "{{ item }}"
      state: restarted 
      enabled: yes
    with_items:
      - rpcbind
      - nfs-server
    tags:
      - nfsserver

  - name: "firewalld allow nfs"
    become: yes
    firewalld:
      zone: public
      service: "{{ item }}"
      permanent: yes
      state: enabled
      immediate: yes
    with_items:
      - nfs
      - nfs3
      - mountd
      - rpc-bind
    ignore_errors: yes
    tags:
      - nfsserver
